// Auto-generated by scripts/bundle-ui.mjs. Do not edit directly.
function formatYen(rawValue) {
    const safeValue = Math.max(Math.round(rawValue), 0);
    return `${safeValue.toLocaleString()}円`;
}

const SIMPLE_KEY = 'furusato-simple-session';
const ADVANCED_KEY = 'furusato-advanced-session';
function getStorage() {
    if (typeof window === 'undefined' || typeof window.localStorage === 'undefined') {
        return null;
    }
    return window.localStorage;
}
function readState(key) {
    const storage = getStorage();
    if (!storage) {
        return null;
    }
    try {
        const raw = storage.getItem(key);
        return raw ? JSON.parse(raw) : null;
    }
    catch (_a) {
        return null;
    }
}
function writeState(key, value) {
    const storage = getStorage();
    if (!storage) {
        return;
    }
    try {
        storage.setItem(key, JSON.stringify(value));
    }
    catch (_a) {
        // Ignore quota errors or disabled storage.
    }
}
function loadSimpleSessionState() {
    return readState(SIMPLE_KEY);
}
function saveSimpleSessionState(state) {
    writeState(SIMPLE_KEY, state);
}
function loadAdvancedSessionState() {
    return readState(ADVANCED_KEY);
}
function saveAdvancedSessionState(state) {
    writeState(ADVANCED_KEY, state);
}

function initTabs(buttonSelector = '.tab-button', panelSelector = '.panel') {
    if (typeof document === 'undefined') {
        return;
    }
    const tabButtons = document.querySelectorAll(buttonSelector);
    const panels = document.querySelectorAll(panelSelector);
    if (!tabButtons.length || !panels.length) {
        return;
    }
    tabButtons.forEach((button) => {
        button.addEventListener('click', () => {
            const targetId = button.dataset.target;
            tabButtons.forEach((btn) => btn.classList.remove('tab-active'));
            button.classList.add('tab-active');
            if (!targetId) {
                return;
            }
            panels.forEach((panel) => {
                if (panel.id === targetId) {
                    panel.removeAttribute('hidden');
                }
                else {
                    panel.setAttribute('hidden', 'true');
                }
            });
            const eventDetail = { id: targetId !== null && targetId !== void 0 ? targetId : null };
            document.dispatchEvent(new CustomEvent('tab:changed', { detail: eventDetail }));
        });
    });
}
function activateTab(targetId, buttonSelector = '.tab-button') {
    const button = document.querySelector(`${buttonSelector}[data-target="${targetId}"]`);
    button === null || button === void 0 ? void 0 : button.click();
}

const DEFAULT_SELECTIONS = {
    family: 'couple-child',
    income: '700',
};
const baseEstimates = {
    150: 12000,
    200: 19000,
    300: 28000,
    400: 42000,
    500: 61000,
    600: 77000,
    700: 106000,
    800: 133000,
    900: 150000,
    1000: 176000,
    1200: 210000,
    1500: 300000,
    2000: 420000,
    3000: 620000,
    5000: 1050000,
    10000: 2100000,
    20000: 4200000,
    30000: 6300000,
};
const familyAdjustments = {
    single: 0,
    couple: -5000,
    'couple-child': -15000,
    extended: -8000,
};
const MAN_YEN = 10000;
const BASIC_DEDUCTION = 480000;
const SPOUSE_DEDUCTION = 380000;
const DEPENDENT_DEDUCTION = 380000;
const NON_TAXABLE_THRESHOLD = 10000;
const SOCIAL_INSURANCE_ESTIMATES = [
    { max: 2000000, rate: 0.24 },
    { max: 4000000, rate: 0.2 },
    { max: 7000000, rate: 0.18 },
    { max: Number.POSITIVE_INFINITY, rate: 0.16 },
];
const defaultSimpleState = {
    family: DEFAULT_SELECTIONS.family,
    income: DEFAULT_SELECTIONS.income,
    oneStop: false,
    largeDeduction: false,
};

function initSimpleSimulator() {
    var _a;
    if (typeof document === 'undefined') {
        return;
    }
    const resultValueTargets = document.querySelectorAll('[data-simple-result="value"]');
    const resultDetailTargets = document.querySelectorAll('[data-simple-result="detail"]');
    const resultNoteTargets = document.querySelectorAll('[data-simple-result="note"]');
    if (!resultValueTargets.length || !resultNoteTargets.length) {
        return;
    }
    const getSelectedInput = (name) => document.querySelector(`input[name="${name}"]:checked`);
    const getSelectedValue = (name) => { var _a, _b; return (_b = (_a = getSelectedInput(name)) === null || _a === void 0 ? void 0 : _a.value) !== null && _b !== void 0 ? _b : null; };
    const setRadioValue = (name, value) => {
        const target = document.querySelector(`input[name="${name}"][value="${value}"]`);
        if (target) {
            target.checked = true;
        }
    };
    const setCheckboxValue = (name, checked) => {
        const target = document.querySelector(`input[name="${name}"]`);
        if (target) {
            target.checked = checked;
        }
    };
    const updateResultCard = ({ amount, detail }) => {
        resultValueTargets.forEach((target) => {
            target.textContent = amount;
        });
        resultDetailTargets.forEach((target) => {
            target.textContent = detail !== null && detail !== void 0 ? detail : '';
            target.toggleAttribute('data-empty', !detail);
        });
        resultNoteTargets.forEach((target) => {
            target.textContent = 'あなたの控除上限額（目安）は';
        });
    };
    const applyStateToInputs = (state) => {
        setRadioValue('family', state.family);
        setRadioValue('income', state.income);
        setCheckboxValue('one-stop', state.oneStop);
        setCheckboxValue('large-deduction', state.largeDeduction);
    };
    const hasSpouseDeduction = (family) => family === 'couple' || family === 'couple-child';
    const hasDependentDeduction = (family) => family === 'couple-child';
    const toAnnualIncome = (selection) => {
        const numericValue = Number(selection);
        if (!Number.isFinite(numericValue) || numericValue <= 0) {
            return 0;
        }
        return numericValue * MAN_YEN;
    };
    const getSalaryDeduction = (annualIncome) => {
        if (annualIncome <= 0) {
            return 0;
        }
        if (annualIncome <= 1625000) {
            return 550000;
        }
        if (annualIncome <= 1800000) {
            return annualIncome * 0.4 - 100000;
        }
        if (annualIncome <= 3600000) {
            return annualIncome * 0.3 + 80000;
        }
        if (annualIncome <= 6600000) {
            return annualIncome * 0.2 + 440000;
        }
        if (annualIncome <= 8500000) {
            return annualIncome * 0.1 + 1100000;
        }
        return 1950000;
    };
    const calculateSalaryIncome = (annualIncome) => {
        const deduction = getSalaryDeduction(annualIncome);
        return Math.max(annualIncome - deduction, 0);
    };
    const estimateSocialInsurance = (annualIncome) => {
        var _a;
        const bracket = (_a = SOCIAL_INSURANCE_ESTIMATES.find(({ max }) => annualIncome <= max)) !== null && _a !== void 0 ? _a : SOCIAL_INSURANCE_ESTIMATES[SOCIAL_INSURANCE_ESTIMATES.length - 1];
        return Math.max(Math.round(annualIncome * bracket.rate), 0);
    };
    const calculateResidentTaxableIncome = (family, annualIncome) => {
        const salaryIncome = calculateSalaryIncome(annualIncome);
        const socialInsurance = estimateSocialInsurance(annualIncome);
        const deductions = BASIC_DEDUCTION +
            socialInsurance +
            (hasSpouseDeduction(family) ? SPOUSE_DEDUCTION : 0) +
            (hasDependentDeduction(family) ? DEPENDENT_DEDUCTION : 0);
        return salaryIncome - deductions;
    };
    function runSimpleSimulation() {
        var _a, _b;
        const selectedFamily = getSelectedValue('family');
        const selectedIncome = getSelectedValue('income');
        const hasOneStop = Boolean(document.querySelector('input[name="one-stop"]:checked'));
        const hasLargeDeduction = Boolean(document.querySelector('input[name="large-deduction"]:checked'));
        if (!selectedFamily || !selectedIncome) {
            updateResultCard({
                amount: '−円',
                detail: '条件を選択してください',
            });
            return;
        }
        const stateToSave = {
            family: selectedFamily,
            income: selectedIncome,
            oneStop: hasOneStop,
            largeDeduction: hasLargeDeduction,
        };
        saveSimpleSessionState(stateToSave);
        document.dispatchEvent(new CustomEvent('simple:state-updated', {
            detail: stateToSave,
        }));
        const annualIncome = toAnnualIncome(selectedIncome);
        const taxableIncome = calculateResidentTaxableIncome(selectedFamily, annualIncome);
        if (taxableIncome <= NON_TAXABLE_THRESHOLD) {
            updateResultCard({
                amount: formatYen(0),
                detail: '住民税が非課税ラインのため、上限額は0円です。',
            });
            return;
        }
        const incomeBase = (_a = baseEstimates[selectedIncome]) !== null && _a !== void 0 ? _a : 0;
        const adjustment = (_b = familyAdjustments[selectedFamily]) !== null && _b !== void 0 ? _b : 0;
        const deductionHit = hasLargeDeduction ? 8000 : 0;
        const oneStopBonus = hasOneStop ? 2000 : 0;
        const estimated = incomeBase + adjustment - deductionHit + oneStopBonus;
        updateResultCard({
            amount: formatYen(estimated),
        });
    }
    const resetSimple = () => {
        applyStateToInputs(defaultSimpleState);
        runSimpleSimulation();
    };
    document.addEventListener('simulator:simple-calc', runSimpleSimulation);
    document.addEventListener('simulator:reset-all', resetSimple);
    document
        .querySelectorAll('input[name="family"], input[name="income"], input[name="one-stop"], input[name="large-deduction"]')
        .forEach((element) => {
        element.addEventListener('change', runSimpleSimulation);
    });
    const savedState = (_a = loadSimpleSessionState()) !== null && _a !== void 0 ? _a : defaultSimpleState;
    applyStateToInputs(savedState);
    runSimpleSimulation();
}

const ADV_BASIC_DEDUCTION = 480000;
const ADV_SPOUSE_DEDUCTION = 380000;
const ADV_DEPENDENT_DEDUCTION = 380000;
const ADV_DISABLED_GENERAL = 270000;
const ADV_DISABLED_SPECIAL = 400000;
const ADV_TAX_BRACKETS = [
    { min: 0, max: 1950000, rate: 0.05, deduction: 0 },
    { min: 1950000, max: 3300000, rate: 0.1, deduction: 97500 },
    { min: 3300000, max: 6950000, rate: 0.2, deduction: 427500 },
    { min: 6950000, max: 9000000, rate: 0.23, deduction: 636000 },
    { min: 9000000, max: 18000000, rate: 0.33, deduction: 1536000 },
    { min: 18000000, max: 40000000, rate: 0.4, deduction: 2796000 },
    { min: 40000000, max: Infinity, rate: 0.45, deduction: 4796000 },
];
const ADVANCED_INPUT_IDS = [
    'adv-income',
    'adv-spouse-income',
    'adv-listed',
    'adv-unlisted',
    'adv-has-spouse',
    'adv-family-type',
    'adv-dependents',
    'adv-disabled',
    'adv-special-self',
    'adv-special-other',
    'adv-social',
    'adv-small-enterprise',
    'adv-life',
    'adv-earthquake',
    'adv-medical',
    'adv-housing',
];
const ADVANCED_MONEY_INPUT_IDS = [
    'adv-income',
    'adv-spouse-income',
    'adv-listed',
    'adv-unlisted',
    'adv-social',
    'adv-small-enterprise',
    'adv-life',
    'adv-earthquake',
    'adv-medical',
    'adv-housing',
];
const ADVANCED_MONEY_INPUT_ID_SET = new Set(ADVANCED_MONEY_INPUT_IDS);
const ADVANCED_DEFAULT_BASE = {
    'adv-income': '7000000',
    'adv-spouse-income': '0',
    'adv-listed': '0',
    'adv-unlisted': '0',
    'adv-has-spouse': 'has',
    'adv-family-type': 'couple',
    'adv-dependents': '1',
    'adv-disabled': '0',
    'adv-special-self': '0',
    'adv-special-other': '0',
    'adv-social': '1260000',
    'adv-small-enterprise': '0',
    'adv-life': '0',
    'adv-earthquake': '0',
    'adv-medical': '0',
    'adv-housing': '0',
};
function isAdvancedInput(element) {
    return element instanceof HTMLInputElement || element instanceof HTMLSelectElement;
}
function buildAdvancedDefaults(simpleState) {
    var _a, _b;
    const defaults = Object.assign({}, ADVANCED_DEFAULT_BASE);
    const incomeSelection = Number((_a = simpleState === null || simpleState === void 0 ? void 0 : simpleState.income) !== null && _a !== void 0 ? _a : defaultSimpleState.income);
    const annualIncome = Number.isFinite(incomeSelection)
        ? Math.max(Math.round(incomeSelection * MAN_YEN), 0)
        : Number(defaults['adv-income']);
    defaults['adv-income'] = String(annualIncome);
    const socialBracket = (_b = SOCIAL_INSURANCE_ESTIMATES.find(({ max }) => annualIncome <= max)) !== null && _b !== void 0 ? _b : SOCIAL_INSURANCE_ESTIMATES[SOCIAL_INSURANCE_ESTIMATES.length - 1];
    defaults['adv-social'] = String(Math.max(Math.round(annualIncome * socialBracket.rate), 0));
    const family = simpleState === null || simpleState === void 0 ? void 0 : simpleState.family;
    if (family) {
        const hasSpouse = family !== 'single';
        const hasDependents = family === 'couple-child' || family === 'extended';
        defaults['adv-has-spouse'] = hasSpouse ? 'has' : 'none';
        defaults['adv-spouse-income'] = hasSpouse ? '0' : '';
        defaults['adv-family-type'] =
            family === 'couple' || family === 'couple-child' ? 'couple' : 'none';
        defaults['adv-dependents'] = hasDependents ? '1' : '0';
    }
    return defaults;
}
function buildAdvancedPreset(simpleState) {
    var _a;
    if (!simpleState) {
        return {};
    }
    const income = Number(simpleState.income);
    const annualIncome = Number.isFinite(income) ? Math.max(Math.round(income * MAN_YEN), 0) : null;
    const hasSpouse = simpleState.family !== 'single';
    const hasDependents = simpleState.family === 'couple-child' || simpleState.family === 'extended';
    const socialBracket = annualIncome !== null
        ? (_a = SOCIAL_INSURANCE_ESTIMATES.find(({ max }) => annualIncome <= max)) !== null && _a !== void 0 ? _a : SOCIAL_INSURANCE_ESTIMATES[SOCIAL_INSURANCE_ESTIMATES.length - 1]
        : null;
    const estimatedSocial = annualIncome !== null && socialBracket
        ? Math.max(Math.round(annualIncome * socialBracket.rate), 0)
        : null;
    return {
        'adv-income': annualIncome !== null ? String(annualIncome) : '',
        'adv-spouse-income': hasSpouse ? '0' : '',
        'adv-has-spouse': hasSpouse ? 'has' : 'none',
        'adv-family-type': simpleState.family === 'couple' || simpleState.family === 'couple-child' ? 'couple' : 'none',
        'adv-dependents': hasDependents ? '1' : '0',
        'adv-social': estimatedSocial !== null ? String(estimatedSocial) : '',
    };
}
function initAdvancedSimulator() {
    var _a;
    if (typeof document === 'undefined') {
        return;
    }
    const advancedForm = document.getElementById('advanced-form');
    const advancedValue = document.getElementById('advanced-value');
    const advancedDetail = document.getElementById('advanced-detail');
    const advancedNote = document.getElementById('advanced-note');
    const advancedFootnote = document.getElementById('advanced-footnote');
    const advancedSpouseSelect = document.getElementById('adv-has-spouse');
    const advancedSpouseIncome = document.getElementById('adv-spouse-income');
    const familyTypeSelect = document.getElementById('adv-family-type');
    if (!advancedValue || !advancedDetail || !advancedNote || !advancedFootnote) {
        return;
    }
    const normalizeNumericString = (value) => value.replace(/[^\d]/g, '');
    const parseMoneyValue = (value) => {
        const normalized = normalizeNumericString(value);
        if (!normalized) {
            return 0;
        }
        const numeric = Number(normalized);
        return Number.isFinite(numeric) && numeric >= 0 ? numeric : 0;
    };
    const formatShortUnit = (amount) => {
        if (amount >= 100000000) {
            const oku = amount / 100000000;
            const rounded = oku >= 10 ? Math.round(oku) : Math.round(oku * 10) / 10;
            const text = Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(1).replace(/\.0$/, '');
            return `${text}億円`;
        }
        if (amount >= 10000) {
            const man = amount / 10000;
            const rounded = man >= 10 ? Math.round(man) : Math.round(man * 10) / 10;
            const text = Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(1).replace(/\.0$/, '');
            return `${text}万円`;
        }
        return '';
    };
    const formatMoneyInputValue = (input) => {
        const caret = input.selectionStart;
        const prevLength = input.value.length;
        const normalized = normalizeNumericString(input.value);
        const amount = parseMoneyValue(normalized);
        input.value = normalized ? amount.toLocaleString('ja-JP') : '';
        if (document.activeElement === input && caret !== null) {
            const diff = input.value.length - prevLength;
            const nextPos = Math.max(caret + diff, 0);
            input.setSelectionRange(nextPos, nextPos);
        }
        return amount;
    };
    const renderMoneyPopover = (input, amount, visible) => {
        var _a;
        const parent = (_a = input === null || input === void 0 ? void 0 : input.parentElement) !== null && _a !== void 0 ? _a : null;
        if (!parent) {
            return;
        }
        let pop = parent.querySelector('.input-pop');
        if (!pop) {
            pop = document.createElement('div');
            pop.className = 'input-pop';
            parent.appendChild(pop);
        }
        if (!visible || amount <= 0) {
            pop.removeAttribute('data-visible');
            pop.textContent = '';
            return;
        }
        const unit = formatShortUnit(amount);
        const text = unit ? `${formatYen(amount)} / ${unit}` : formatYen(amount);
        pop.textContent = text;
        pop.dataset.visible = 'true';
    };
    const syncMoneyInput = (input, { showPopover = false } = {}) => {
        const amount = formatMoneyInputValue(input);
        renderMoneyPopover(input, amount, showPopover);
        return amount;
    };
    const enhanceMoneyInputs = () => {
        ADVANCED_MONEY_INPUT_IDS.forEach((id) => {
            var _a;
            const input = document.getElementById(id);
            if (!(input instanceof HTMLInputElement)) {
                return;
            }
            input.type = 'text';
            input.inputMode = 'numeric';
            input.autocomplete = 'off';
            input.pattern = '\\d{1,3}(,\\d{3})*';
            input.placeholder = (_a = input.placeholder) !== null && _a !== void 0 ? _a : '0';
            input.addEventListener('focus', () => syncMoneyInput(input, { showPopover: true }));
            input.addEventListener('input', () => syncMoneyInput(input, { showPopover: true }));
            input.addEventListener('blur', () => renderMoneyPopover(input, parseMoneyValue(input.value), false));
            input.addEventListener('mouseenter', () => renderMoneyPopover(input, parseMoneyValue(input.value), true));
            input.addEventListener('mouseleave', () => renderMoneyPopover(input, parseMoneyValue(input.value), false));
            syncMoneyInput(input);
        });
    };
    const refreshMoneyInputs = () => {
        ADVANCED_MONEY_INPUT_IDS.forEach((id) => {
            const input = document.getElementById(id);
            if (input instanceof HTMLInputElement) {
                syncMoneyInput(input);
            }
        });
    };
    const clearAutofillFlag = (event) => {
        const target = event.target;
        if (isAdvancedInput(target)) {
            target.dataset.autofill = 'manual';
        }
    };
    const applyAdvancedState = (state, { preferExisting = false } = {}) => {
        if (!state) {
            return;
        }
        ADVANCED_INPUT_IDS.forEach((id) => {
            var _a;
            const element = document.getElementById(id);
            if (!isAdvancedInput(element) || typeof state[id] !== 'string') {
                return;
            }
            if (preferExisting && element.value !== '') {
                return;
            }
            element.value = (_a = state[id]) !== null && _a !== void 0 ? _a : '';
            if (element instanceof HTMLInputElement && ADVANCED_MONEY_INPUT_ID_SET.has(id)) {
                syncMoneyInput(element);
            }
        });
    };
    const collectAdvancedState = () => {
        const result = {};
        ADVANCED_INPUT_IDS.forEach((id) => {
            var _a;
            const element = document.getElementById(id);
            if (!isAdvancedInput(element)) {
                return;
            }
            if (element instanceof HTMLInputElement && ADVANCED_MONEY_INPUT_ID_SET.has(id)) {
                result[id] = normalizeNumericString(element.value);
                return;
            }
            result[id] = (_a = element.value) !== null && _a !== void 0 ? _a : '';
        });
        return result;
    };
    const persistAdvancedState = () => {
        saveAdvancedSessionState(collectAdvancedState());
    };
    const applySimplePreset = (simpleState) => {
        if (!simpleState) {
            return;
        }
        const preset = buildAdvancedPreset(simpleState);
        ADVANCED_INPUT_IDS.forEach((id) => {
            const element = document.getElementById(id);
            if (!isAdvancedInput(element)) {
                return;
            }
            const nextValue = preset[id];
            if (typeof nextValue !== 'string') {
                return;
            }
            const canOverride = element.dataset.autofill !== 'manual';
            if (!canOverride) {
                return;
            }
            element.value = nextValue;
            element.dataset.autofill = 'simple';
            if (element instanceof HTMLInputElement && ADVANCED_MONEY_INPUT_ID_SET.has(id)) {
                syncMoneyInput(element);
            }
        });
        handleSpouseRequirement();
        persistAdvancedState();
    };
    const parseAmount = (id) => {
        const element = document.getElementById(id);
        if (!(element instanceof HTMLInputElement)) {
            return 0;
        }
        return parseMoneyValue(element.value);
    };
    const parseCount = (id) => Math.max(0, Math.floor(parseAmount(id)));
    const getTaxRate = (taxableIncome) => {
        var _a;
        const bracket = (_a = ADV_TAX_BRACKETS.find((candidate) => taxableIncome >= candidate.min && taxableIncome < candidate.max)) !== null && _a !== void 0 ? _a : ADV_TAX_BRACKETS[0];
        return { rate: bracket.rate, deduction: bracket.deduction };
    };
    const resetAdvancedResult = () => {
        advancedValue.textContent = '−円';
        advancedNote.textContent = '入力すると控除上限額（目安）を計算します';
        advancedDetail.textContent = '年収と控除の金額を入力してください';
        advancedFootnote.textContent =
            '基礎控除や扶養控除を加味した目安額です。実際の金額はお手元の証憑でご確認ください。';
    };
    const handleSpouseRequirement = () => {
        if (!advancedSpouseSelect || !advancedSpouseIncome) {
            return;
        }
        const needsSpouseIncome = advancedSpouseSelect.value === 'has';
        advancedSpouseIncome.required = needsSpouseIncome;
        advancedSpouseIncome.disabled = !needsSpouseIncome;
        advancedSpouseIncome.placeholder = needsSpouseIncome ? '0' : '配偶者なし';
        if (!needsSpouseIncome) {
            advancedSpouseIncome.value = '';
        }
        syncMoneyInput(advancedSpouseIncome);
        if (!needsSpouseIncome) {
            renderMoneyPopover(advancedSpouseIncome, 0, false);
        }
        persistAdvancedState();
        refreshAdvancedResult();
    };
    const getFamilyText = (value) => {
        if (value === 'couple') {
            return '夫婦のみ世帯';
        }
        if (value === 'single-parent') {
            return 'ひとり親世帯';
        }
        return '一般世帯';
    };
    const calculateAdvanced = () => {
        var _a;
        const salaryIncome = parseAmount('adv-income');
        const spouseIncome = parseAmount('adv-spouse-income');
        const listedGain = parseAmount('adv-listed');
        const unlistedGain = parseAmount('adv-unlisted');
        const familyType = (_a = familyTypeSelect === null || familyTypeSelect === void 0 ? void 0 : familyTypeSelect.value) !== null && _a !== void 0 ? _a : 'none';
        const hasSpouse = (advancedSpouseSelect === null || advancedSpouseSelect === void 0 ? void 0 : advancedSpouseSelect.value) === 'has';
        const dependents = parseCount('adv-dependents');
        const disabled = parseCount('adv-disabled');
        const specialSelf = parseCount('adv-special-self');
        const specialOther = parseCount('adv-special-other');
        const socialInsurance = parseAmount('adv-social');
        const smallEnterprise = parseAmount('adv-small-enterprise');
        const lifeInsurance = parseAmount('adv-life');
        const earthquakeInsurance = parseAmount('adv-earthquake');
        const medicalDeduction = parseAmount('adv-medical');
        const housingDeduction = parseAmount('adv-housing');
        const totalIncome = salaryIncome + listedGain + unlistedGain;
        const spouseDeduction = hasSpouse && spouseIncome <= 1060000 ? ADV_SPOUSE_DEDUCTION : 0;
        const dependentDeduction = dependents * ADV_DEPENDENT_DEDUCTION;
        const disabledDeduction = disabled * ADV_DISABLED_GENERAL +
            (specialSelf + specialOther) * ADV_DISABLED_SPECIAL;
        const totalDeductions = ADV_BASIC_DEDUCTION +
            spouseDeduction +
            dependentDeduction +
            disabledDeduction +
            socialInsurance +
            smallEnterprise +
            lifeInsurance +
            earthquakeInsurance +
            medicalDeduction +
            housingDeduction;
        const taxableIncome = Math.max(totalIncome - totalDeductions, 0);
        const taxableRounded = Math.floor(taxableIncome / 1000) * 1000;
        const { rate: incomeTaxRate, deduction: incomeTaxDeductionBase } = getTaxRate(taxableRounded);
        const incomeTaxAmount = Math.max(Math.round(taxableRounded * incomeTaxRate - incomeTaxDeductionBase), 0);
        const residentTaxAmount = Math.max(Math.round(taxableRounded * 0.1), 0);
        const incomeLimit = totalIncome * 0.4 + 2000;
        const specialRate = 1 - incomeTaxRate - 0.1;
        const residentLimit = specialRate > 0
            ? (residentTaxAmount * 0.2) / specialRate + 2000
            : Number.POSITIVE_INFINITY;
        const maxDonationRaw = Math.min(incomeLimit, residentLimit);
        const maxDonation = Math.max(Math.round(Number.isFinite(maxDonationRaw) ? maxDonationRaw : 0), 0);
        const donationTarget = Math.max(maxDonation - 2000, 0);
        const incomeTaxDeduction = Math.round(donationTarget * incomeTaxRate);
        const residentBasicDeduction = Math.round(donationTarget * 0.1);
        const residentSpecialDeduction = Math.round(Math.min(Math.max(donationTarget * (1 - incomeTaxRate - 0.1), 0), residentTaxAmount * 0.2));
        const totalTaxDeduction = incomeTaxDeduction + residentBasicDeduction + residentSpecialDeduction;
        const actualCost = Math.max(maxDonation - totalTaxDeduction, 0);
        advancedValue.textContent = formatYen(maxDonation);
        advancedNote.textContent = 'あなたの控除上限額（目安）';
        advancedDetail.textContent = `${hasSpouse ? '配偶者あり' : '配偶者なし'} / ${dependents}人扶養 / 課税所得${formatYen(taxableRounded)} をもとに試算しています`;
        advancedFootnote.textContent = `(${getFamilyText(familyType)}) 概算控除額: 所得税${formatYen(incomeTaxDeduction)}・住民税(基本) ${formatYen(residentBasicDeduction)}・住民税(特例) ${formatYen(residentSpecialDeduction)}。この条件で寄付すると自己負担の目安は ${formatYen(actualCost)} です。`;
    };
    function refreshAdvancedResult({ reportValidity = false } = {}) {
        if (!(advancedForm instanceof HTMLFormElement)) {
            return;
        }
        const isValid = advancedForm.checkValidity();
        if (!isValid) {
            if (reportValidity) {
                advancedForm.reportValidity();
            }
            resetAdvancedResult();
            return;
        }
        calculateAdvanced();
    }
    document.addEventListener('simulator:advanced-calc', () => {
        refreshAdvancedResult({ reportValidity: true });
    });
    document.addEventListener('simulator:reset-all', () => {
        var _a;
        (_a = advancedForm) === null || _a === void 0 ? void 0 : _a.reset();
    });
    advancedForm === null || advancedForm === void 0 ? void 0 : advancedForm.addEventListener('submit', (event) => {
        event.preventDefault();
        refreshAdvancedResult({ reportValidity: true });
    });
    const persistOnInteraction = (event) => {
        clearAutofillFlag(event);
        persistAdvancedState();
        refreshAdvancedResult();
    };
    advancedForm === null || advancedForm === void 0 ? void 0 : advancedForm.addEventListener('input', persistOnInteraction);
    advancedForm === null || advancedForm === void 0 ? void 0 : advancedForm.addEventListener('change', persistOnInteraction);
    advancedForm === null || advancedForm === void 0 ? void 0 : advancedForm.addEventListener('reset', () => {
        setTimeout(() => {
            var _a;
            const simpleState = (_a = loadSimpleSessionState()) !== null && _a !== void 0 ? _a : defaultSimpleState;
            applyAdvancedState(buildAdvancedDefaults(simpleState));
            applySimplePreset(simpleState);
            refreshMoneyInputs();
            refreshAdvancedResult();
            persistAdvancedState();
        }, 0);
    });
    advancedSpouseSelect === null || advancedSpouseSelect === void 0 ? void 0 : advancedSpouseSelect.addEventListener('change', handleSpouseRequirement);
    const simpleInitialState = (_a = loadSimpleSessionState()) !== null && _a !== void 0 ? _a : defaultSimpleState;
    const savedAdvancedState = loadAdvancedSessionState();
    const advancedInitialState = Object.assign({}, buildAdvancedDefaults(simpleInitialState));
    if (savedAdvancedState) {
        Object.entries(savedAdvancedState).forEach(([key, value]) => {
            if (typeof value === 'string' && value !== '') {
                advancedInitialState[key] = value;
            }
        });
    }
    enhanceMoneyInputs();
    applyAdvancedState(advancedInitialState);
    applySimplePreset(simpleInitialState);
    handleSpouseRequirement();
    refreshMoneyInputs();
    refreshAdvancedResult();
    persistAdvancedState();
    const advancedTab = document.getElementById('tab-advanced');
    advancedTab === null || advancedTab === void 0 ? void 0 : advancedTab.addEventListener('click', () => {
        const simpleState = loadSimpleSessionState();
        applySimplePreset(simpleState);
    });
    document.addEventListener('simple:state-updated', (event) => {
        const simpleState = event.detail;
        applySimplePreset(simpleState !== null && simpleState !== void 0 ? simpleState : null);
    });
}

function initTabToggleCta() {
    var _a;
    if (typeof document === 'undefined') {
        return;
    }
    const cta = document.querySelector('[data-role="tab-toggle-cta"]');
    const simplePanelId = 'panel-simple';
    const advancedPanelId = 'panel-advanced';
    if (!cta) {
        return;
    }
    const updateCta = (activePanelId) => {
        const onAdvanced = activePanelId === advancedPanelId;
        cta.textContent = onAdvanced ? '簡易シミュレーションに進む' : '詳細シミュレーションに進む';
        cta.dataset.nextTab = onAdvanced ? simplePanelId : advancedPanelId;
    };
    cta.addEventListener('click', (event) => {
        var _a;
        event.preventDefault();
        const targetId = (_a = cta.dataset.nextTab) !== null && _a !== void 0 ? _a : advancedPanelId;
        activateTab(targetId);
        cta.blur();
    });
    document.addEventListener('tab:changed', (event) => {
        var _a;
        const detail = event.detail;
        updateCta((_a = detail === null || detail === void 0 ? void 0 : detail.id) !== null && _a !== void 0 ? _a : null);
    });
    const initialActive = document.querySelector('.tab-button.tab-active');
    updateCta((_a = initialActive === null || initialActive === void 0 ? void 0 : initialActive.dataset.target) !== null && _a !== void 0 ? _a : null);
}
function initModeSwitch() {
    var _a, _b;
    if (typeof document === 'undefined') {
        return;
    }
    const buttons = Array.from(document.querySelectorAll('[data-role="mode-switch"]'));
    if (!buttons.length) {
        return;
    }
    const setActive = (targetId) => {
        buttons.forEach((btn) => {
            btn.classList.toggle('mode-switch__item--active', btn.dataset.target === targetId);
        });
    };
    buttons.forEach((btn) => {
        btn.addEventListener('click', () => {
            const targetId = btn.dataset.target;
            if (targetId) {
                activateTab(targetId);
            }
            setActive(targetId !== null && targetId !== void 0 ? targetId : null);
        });
    });
    document.addEventListener('tab:changed', (event) => {
        var _a;
        setActive((_a = event.detail) === null || _a === void 0 ? void 0 : _a.id);
    });
    const initialActive = (_b = (_a = document.querySelector('.tab-button.tab-active')) === null || _a === void 0 ? void 0 : _a.dataset.target) !== null && _b !== void 0 ? _b : null;
    setActive(initialActive);
}
function initBarActions() {
    if (typeof document === 'undefined') {
        return;
    }
    const calcButton = document.getElementById('bar-calc');
    const resetButton = document.getElementById('bar-reset');
    const tabButtons = Array.from(document.querySelectorAll('.tab-button'));
    const findActivePanel = () => {
        var _a;
        return (_a = tabButtons.find((btn) => btn.classList.contains('tab-active'))) === null || _a === void 0 ? void 0 : _a.dataset.target;
    };
    let activePanelId = findActivePanel() !== null && findActivePanel() !== void 0 ? findActivePanel() : 'panel-simple';
    const updateCalcLabel = () => {
        var _a;
        const isAdvanced = activePanelId === 'panel-advanced';
        (_a = calcButton) === null || _a === void 0 ? void 0 : _a.textContent = isAdvanced ? '詳細を計算する' : '簡易を計算する';
    };
    calcButton === null || calcButton === void 0 ? void 0 : calcButton.addEventListener('click', () => {
        const eventName = activePanelId === 'panel-advanced' ? 'simulator:advanced-calc' : 'simulator:simple-calc';
        document.dispatchEvent(new CustomEvent(eventName));
    });
    resetButton === null || resetButton === void 0 ? void 0 : resetButton.addEventListener('click', () => {
        document.dispatchEvent(new CustomEvent('simulator:reset-all'));
    });
    document.addEventListener('tab:changed', (event) => {
        var _a;
        const targetId = (_a = event.detail) === null || _a === void 0 ? void 0 : _a.id;
        if (typeof targetId === 'string' && targetId.length > 0) {
            activePanelId = targetId;
            updateCalcLabel();
        }
    });
    updateCalcLabel();
}
function bootstrap() {
    initTabs();
    initSimpleSimulator();
    initAdvancedSimulator();
    initTabToggleCta();
    initModeSwitch();
    initBarActions();
}
if (typeof document !== 'undefined') {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bootstrap);
    }
    else {
        bootstrap();
    }
}
