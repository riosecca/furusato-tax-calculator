// Auto-generated by scripts/bundle-ui.mjs. Do not edit directly.
function formatYen(rawValue) {
    const safeValue = Math.max(Math.round(rawValue), 0);
    return `${safeValue.toLocaleString()}円`;
}

const SIMPLE_KEY = 'furusato-simple-session';
const ADVANCED_KEY = 'furusato-advanced-session';
function getStorage() {
    if (typeof window === 'undefined' || typeof window.localStorage === 'undefined') {
        return null;
    }
    return window.localStorage;
}
function readState(key) {
    const storage = getStorage();
    if (!storage) {
        return null;
    }
    try {
        const raw = storage.getItem(key);
        return raw ? JSON.parse(raw) : null;
    }
    catch (_a) {
        return null;
    }
}
function writeState(key, value) {
    const storage = getStorage();
    if (!storage) {
        return;
    }
    try {
        storage.setItem(key, JSON.stringify(value));
    }
    catch (_a) {
        // Ignore quota errors or disabled storage.
    }
}
function loadSimpleSessionState() {
    return readState(SIMPLE_KEY);
}
function saveSimpleSessionState(state) {
    writeState(SIMPLE_KEY, state);
}
function loadAdvancedSessionState() {
    return readState(ADVANCED_KEY);
}
function saveAdvancedSessionState(state) {
    writeState(ADVANCED_KEY, state);
}

function initTabs(buttonSelector = '.tab-button', panelSelector = '.panel') {
    if (typeof document === 'undefined') {
        return;
    }
    const tabButtons = document.querySelectorAll(buttonSelector);
    const panels = document.querySelectorAll(panelSelector);
    if (!tabButtons.length || !panels.length) {
        return;
    }
    tabButtons.forEach((button) => {
        button.addEventListener('click', () => {
            const targetId = button.dataset.target;
            tabButtons.forEach((btn) => btn.classList.remove('tab-active'));
            button.classList.add('tab-active');
            if (!targetId) {
                return;
            }
            panels.forEach((panel) => {
                if (panel.id === targetId) {
                    panel.removeAttribute('hidden');
                }
                else {
                    panel.setAttribute('hidden', 'true');
                }
            });
        });
    });
}

const DEFAULT_SELECTIONS = {
    family: 'couple-child',
    income: '700',
};
const baseEstimates = {
    150: 12000,
    200: 19000,
    300: 28000,
    400: 42000,
    700: 106000,
    1000: 176000,
    1200: 210000,
};
const familyAdjustments = {
    single: 0,
    couple: -5000,
    'couple-child': -15000,
    extended: -8000,
};
const defaultSimpleState = {
    family: DEFAULT_SELECTIONS.family,
    income: DEFAULT_SELECTIONS.income,
    oneStop: false,
    largeDeduction: false,
};
function initSimpleSimulator() {
    var _a;
    if (typeof document === 'undefined') {
        return;
    }
    const calcButton = document.getElementById('btn-simple-calc');
    const resetButton = document.getElementById('btn-simple-reset');
    const resultValue = document.getElementById('result-value');
    const resultDetail = document.getElementById('result-detail');
    const resultNote = document.getElementById('result-note');
    if (!resultValue || !resultDetail || !resultNote) {
        return;
    }
    const getSelectedInput = (name) => document.querySelector(`input[name="${name}"]:checked`);
    const getSelectedValue = (name) => { var _a, _b; return (_b = (_a = getSelectedInput(name)) === null || _a === void 0 ? void 0 : _a.value) !== null && _b !== void 0 ? _b : null; };
    const setRadioValue = (name, value) => {
        const target = document.querySelector(`input[name="${name}"][value="${value}"]`);
        if (target) {
            target.checked = true;
        }
    };
    const setCheckboxValue = (name, checked) => {
        const target = document.querySelector(`input[name="${name}"]`);
        if (target) {
            target.checked = checked;
        }
    };
    const updateResultCard = ({ amount, detail }) => {
        resultValue.textContent = amount;
        resultDetail.textContent = detail !== null && detail !== void 0 ? detail : '';
        resultNote.textContent = 'あなたの控除上限額（目安）は';
    };
    const applyStateToInputs = (state) => {
        setRadioValue('family', state.family);
        setRadioValue('income', state.income);
        setCheckboxValue('one-stop', state.oneStop);
        setCheckboxValue('large-deduction', state.largeDeduction);
    };
    function runSimpleSimulation() {
        var _a, _b;
        const selectedFamily = getSelectedValue('family');
        const selectedIncome = getSelectedValue('income');
        const hasOneStop = Boolean(document.querySelector('input[name="one-stop"]:checked'));
        const hasLargeDeduction = Boolean(document.querySelector('input[name="large-deduction"]:checked'));
        if (!selectedFamily || !selectedIncome) {
            updateResultCard({
                amount: '−円',
                detail: '条件を選択してください',
            });
            return;
        }
        const stateToSave = {
            family: selectedFamily,
            income: selectedIncome,
            oneStop: hasOneStop,
            largeDeduction: hasLargeDeduction,
        };
        saveSimpleSessionState(stateToSave);
        const incomeBase = (_a = baseEstimates[selectedIncome]) !== null && _a !== void 0 ? _a : 0;
        const adjustment = (_b = familyAdjustments[selectedFamily]) !== null && _b !== void 0 ? _b : 0;
        const deductionHit = hasLargeDeduction ? 8000 : 0;
        const oneStopBonus = hasOneStop ? 2000 : 0;
        const estimated = incomeBase + adjustment - deductionHit + oneStopBonus;
        updateResultCard({
            amount: formatYen(estimated),
        });
    }
    calcButton === null || calcButton === void 0 ? void 0 : calcButton.addEventListener('click', runSimpleSimulation);
    document
        .querySelectorAll('input[name="family"], input[name="income"], input[name="one-stop"], input[name="large-deduction"]')
        .forEach((element) => {
        element.addEventListener('change', runSimpleSimulation);
    });
    resetButton === null || resetButton === void 0 ? void 0 : resetButton.addEventListener('click', () => {
        applyStateToInputs(defaultSimpleState);
        runSimpleSimulation();
    });
    const savedState = (_a = loadSimpleSessionState()) !== null && _a !== void 0 ? _a : defaultSimpleState;
    applyStateToInputs(savedState);
    runSimpleSimulation();
}

const ADV_BASIC_DEDUCTION = 480000;
const ADV_SPOUSE_DEDUCTION = 380000;
const ADV_DEPENDENT_DEDUCTION = 380000;
const ADV_DISABLED_GENERAL = 270000;
const ADV_DISABLED_SPECIAL = 400000;
const ADV_TAX_BRACKETS = [
    { min: 0, max: 1950000, rate: 0.05, deduction: 0 },
    { min: 1950000, max: 3300000, rate: 0.1, deduction: 97500 },
    { min: 3300000, max: 6950000, rate: 0.2, deduction: 427500 },
    { min: 6950000, max: 9000000, rate: 0.23, deduction: 636000 },
    { min: 9000000, max: 18000000, rate: 0.33, deduction: 1536000 },
    { min: 18000000, max: 40000000, rate: 0.4, deduction: 2796000 },
    { min: 40000000, max: Infinity, rate: 0.45, deduction: 4796000 },
];
const ADVANCED_INPUT_IDS = [
    'adv-income',
    'adv-spouse-income',
    'adv-listed',
    'adv-unlisted',
    'adv-has-spouse',
    'adv-family-type',
    'adv-dependents',
    'adv-disabled',
    'adv-special-self',
    'adv-special-other',
    'adv-social',
    'adv-small-enterprise',
    'adv-life',
    'adv-earthquake',
    'adv-medical',
    'adv-housing',
];
function isAdvancedInput(element) {
    return element instanceof HTMLInputElement || element instanceof HTMLSelectElement;
}
function initAdvancedSimulator() {
    if (typeof document === 'undefined') {
        return;
    }
    const advancedForm = document.getElementById('advanced-form');
    const advancedValue = document.getElementById('advanced-value');
    const advancedDetail = document.getElementById('advanced-detail');
    const advancedNote = document.getElementById('advanced-note');
    const advancedFootnote = document.getElementById('advanced-footnote');
    const advancedSpouseSelect = document.getElementById('adv-has-spouse');
    const advancedSpouseIncome = document.getElementById('adv-spouse-income');
    const familyTypeSelect = document.getElementById('adv-family-type');
    if (!advancedValue || !advancedDetail || !advancedNote || !advancedFootnote) {
        return;
    }
    const applyAdvancedState = (state) => {
        if (!state) {
            return;
        }
        ADVANCED_INPUT_IDS.forEach((id) => {
            var _a;
            const element = document.getElementById(id);
            if (isAdvancedInput(element) && typeof state[id] === 'string') {
                element.value = (_a = state[id]) !== null && _a !== void 0 ? _a : '';
            }
        });
    };
    const collectAdvancedState = () => {
        const result = {};
        ADVANCED_INPUT_IDS.forEach((id) => {
            var _a;
            const element = document.getElementById(id);
            if (isAdvancedInput(element)) {
                result[id] = (_a = element.value) !== null && _a !== void 0 ? _a : '';
            }
        });
        return result;
    };
    const persistAdvancedState = () => {
        saveAdvancedSessionState(collectAdvancedState());
    };
    const parseAmount = (id) => {
        const element = document.getElementById(id);
        if (!(element instanceof HTMLInputElement)) {
            return 0;
        }
        const value = Number(element.value);
        return Number.isFinite(value) && value >= 0 ? value : 0;
    };
    const parseCount = (id) => Math.max(0, Math.floor(parseAmount(id)));
    const getTaxRate = (taxableIncome) => {
        var _a;
        const bracket = (_a = ADV_TAX_BRACKETS.find((candidate) => taxableIncome >= candidate.min && taxableIncome < candidate.max)) !== null && _a !== void 0 ? _a : ADV_TAX_BRACKETS[0];
        return { rate: bracket.rate, deduction: bracket.deduction };
    };
    const resetAdvancedResult = () => {
        advancedValue.textContent = '−円';
        advancedNote.textContent = '入力すると控除上限額（目安）を計算します';
        advancedDetail.textContent = '年収と控除の内訳を入力してください';
        advancedFootnote.textContent =
            '基礎控除や扶養控除を加味した目安額です。実際の金額はお手元の証憑でご確認ください。';
    };
    const ensureAdvancedValid = () => {
        if (!(advancedForm instanceof HTMLFormElement)) {
            return false;
        }
        if (!advancedForm.checkValidity()) {
            advancedForm.reportValidity();
            return false;
        }
        return true;
    };
    const handleSpouseRequirement = () => {
        if (!advancedSpouseSelect || !advancedSpouseIncome) {
            return;
        }
        const needsSpouseIncome = advancedSpouseSelect.value === 'has';
        advancedSpouseIncome.required = needsSpouseIncome;
        advancedSpouseIncome.disabled = !needsSpouseIncome;
        advancedSpouseIncome.placeholder = needsSpouseIncome ? '0' : '配偶者なし';
        if (!needsSpouseIncome) {
            advancedSpouseIncome.value = '';
        }
        persistAdvancedState();
    };
    const getFamilyText = (value) => {
        if (value === 'couple') {
            return '夫婦のみ世帯';
        }
        if (value === 'single-parent') {
            return 'ひとり親世帯';
        }
        return '一般世帯';
    };
    const calculateAdvanced = () => {
        var _a;
        const salaryIncome = parseAmount('adv-income');
        const spouseIncome = parseAmount('adv-spouse-income');
        const listedGain = parseAmount('adv-listed');
        const unlistedGain = parseAmount('adv-unlisted');
        const familyType = (_a = familyTypeSelect === null || familyTypeSelect === void 0 ? void 0 : familyTypeSelect.value) !== null && _a !== void 0 ? _a : 'none';
        const hasSpouse = (advancedSpouseSelect === null || advancedSpouseSelect === void 0 ? void 0 : advancedSpouseSelect.value) === 'has';
        const dependents = parseCount('adv-dependents');
        const disabled = parseCount('adv-disabled');
        const specialSelf = parseCount('adv-special-self');
        const specialOther = parseCount('adv-special-other');
        const socialInsurance = parseAmount('adv-social');
        const smallEnterprise = parseAmount('adv-small-enterprise');
        const lifeInsurance = parseAmount('adv-life');
        const earthquakeInsurance = parseAmount('adv-earthquake');
        const medicalDeduction = parseAmount('adv-medical');
        const housingDeduction = parseAmount('adv-housing');
        const totalIncome = salaryIncome + listedGain + unlistedGain;
        const spouseDeduction = hasSpouse && spouseIncome <= 1060000 ? ADV_SPOUSE_DEDUCTION : 0;
        const dependentDeduction = dependents * ADV_DEPENDENT_DEDUCTION;
        const disabledDeduction = disabled * ADV_DISABLED_GENERAL +
            (specialSelf + specialOther) * ADV_DISABLED_SPECIAL;
        const totalDeductions = ADV_BASIC_DEDUCTION +
            spouseDeduction +
            dependentDeduction +
            disabledDeduction +
            socialInsurance +
            smallEnterprise +
            lifeInsurance +
            earthquakeInsurance +
            medicalDeduction +
            housingDeduction;
        const taxableIncome = Math.max(totalIncome - totalDeductions, 0);
        const taxableRounded = Math.floor(taxableIncome / 1000) * 1000;
        const { rate: incomeTaxRate, deduction: incomeTaxDeductionBase } = getTaxRate(taxableRounded);
        const incomeTaxAmount = Math.max(Math.round(taxableRounded * incomeTaxRate - incomeTaxDeductionBase), 0);
        const residentTaxAmount = Math.max(Math.round(taxableRounded * 0.1), 0);
        const incomeLimit = totalIncome * 0.4 + 2000;
        const specialRate = 1 - incomeTaxRate - 0.1;
        const residentLimit = specialRate > 0
            ? (residentTaxAmount * 0.2) / specialRate + 2000
            : Number.POSITIVE_INFINITY;
        const maxDonationRaw = Math.min(incomeLimit, residentLimit);
        const maxDonation = Math.max(Math.round(Number.isFinite(maxDonationRaw) ? maxDonationRaw : 0), 0);
        const donationTarget = Math.max(maxDonation - 2000, 0);
        const incomeTaxDeduction = Math.round(donationTarget * incomeTaxRate);
        const residentBasicDeduction = Math.round(donationTarget * 0.1);
        const residentSpecialDeduction = Math.round(Math.min(Math.max(donationTarget * (1 - incomeTaxRate - 0.1), 0), residentTaxAmount * 0.2));
        const totalTaxDeduction = incomeTaxDeduction + residentBasicDeduction + residentSpecialDeduction;
        const actualCost = Math.max(maxDonation - totalTaxDeduction, 0);
        advancedValue.textContent = formatYen(maxDonation);
        advancedNote.textContent = 'あなたの控除上限額（目安）は';
        advancedDetail.textContent = `${hasSpouse ? '配偶者あり' : '配偶者なし'} / ${dependents}人扶養 / 課税所得 ${formatYen(taxableRounded)} をもとに試算しています`;
        advancedFootnote.textContent = `(${getFamilyText(familyType)}) 概算控除内訳: 所得税 ${formatYen(incomeTaxDeduction)}・住民税(基本) ${formatYen(residentBasicDeduction)}・住民税(特例) ${formatYen(residentSpecialDeduction)}。この条件で寄附すると自己負担の目安は ${formatYen(actualCost)} です。`;
    };
    advancedForm === null || advancedForm === void 0 ? void 0 : advancedForm.addEventListener('submit', (event) => {
        event.preventDefault();
        if (!ensureAdvancedValid()) {
            return;
        }
        calculateAdvanced();
    });
    const persistOnInteraction = () => {
        persistAdvancedState();
    };
    advancedForm === null || advancedForm === void 0 ? void 0 : advancedForm.addEventListener('input', persistOnInteraction);
    advancedForm === null || advancedForm === void 0 ? void 0 : advancedForm.addEventListener('change', persistOnInteraction);
    advancedForm === null || advancedForm === void 0 ? void 0 : advancedForm.addEventListener('reset', () => {
        setTimeout(() => {
            resetAdvancedResult();
            handleSpouseRequirement();
            persistAdvancedState();
        }, 0);
    });
    advancedSpouseSelect === null || advancedSpouseSelect === void 0 ? void 0 : advancedSpouseSelect.addEventListener('change', handleSpouseRequirement);
    applyAdvancedState(loadAdvancedSessionState());
    handleSpouseRequirement();
    resetAdvancedResult();
    persistAdvancedState();
}

function bootstrap() {
    initTabs();
    initSimpleSimulator();
    initAdvancedSimulator();
}
if (typeof document !== 'undefined') {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bootstrap);
    }
    else {
        bootstrap();
    }
}
